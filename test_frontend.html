<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Features Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            font-size: 18px;
            margin-top: 0;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #cce5ff;
            color: #004085;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .toggle-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª GeoGov Frontend Features Test</h1>
    
    <div class="test-section">
        <h2>1. RAG Toggle Feature</h2>
        <p>Current Mode: <span id="current-mode" class="status info">Loading...</span></p>
        <div class="toggle-button">
            <button id="toggle-rag" onclick="toggleRAG()">Toggle RAG Mode</button>
            <button onclick="checkRAGStatus()">Refresh Status</button>
        </div>
        <pre id="rag-response"></pre>
    </div>

    <div class="test-section">
        <h2>2. Quick Analysis Test</h2>
        <button onclick="testAnalysis(false)">Test Direct Mode (Fast)</button>
        <button onclick="testAnalysis(true)">Test RAG Mode (Comprehensive)</button>
        <pre id="analysis-response"></pre>
    </div>

    <div class="test-section">
        <h2>3. System Health Check</h2>
        <button onclick="checkHealth()">Check System Health</button>
        <pre id="health-response"></pre>
    </div>

    <div class="test-section">
        <h2>4. Frontend UI Check</h2>
        <p>âœ… RAG toggle button added to SystemStatus component</p>
        <p>âœ… API client updated with toggleRag function</p>
        <p>âœ… Audit Trail filter logic fixed (confidence <= instead of <)</p>
        <p>âœ… Loading stages adapt to RAG/Direct mode</p>
        <p>âœ… Estimated time updates based on mode</p>
        <br>
        <p><a href="http://localhost:3001/" target="_blank" style="color: #007bff;">Open Frontend UI â†’</a></p>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        async function checkRAGStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/rag_status`);
                const data = await response.json();
                
                const modeElement = document.getElementById('current-mode');
                if (data.use_rag) {
                    modeElement.textContent = 'RAG Mode (Comprehensive)';
                    modeElement.className = 'status info';
                } else {
                    modeElement.textContent = 'Direct Mode (Fast)';
                    modeElement.className = 'status success';
                }
                
                document.getElementById('rag-response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('current-mode').textContent = 'Error';
                document.getElementById('current-mode').className = 'status error';
                document.getElementById('rag-response').textContent = 'Error: ' + error.message;
            }
        }

        async function toggleRAG() {
            const button = document.getElementById('toggle-rag');
            button.disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/toggle_rag`, {
                    method: 'POST'
                });
                const data = await response.json();
                document.getElementById('rag-response').textContent = JSON.stringify(data, null, 2);
                await checkRAGStatus();
            } catch (error) {
                document.getElementById('rag-response').textContent = 'Error: ' + error.message;
            } finally {
                button.disabled = false;
            }
        }

        async function testAnalysis(useRAG) {
            try {
                // First set the mode
                await fetch(`${API_BASE}/api/toggle_rag?enable=${useRAG}`, {
                    method: 'POST'
                });
                
                const testFeature = {
                    feature_id: 'test_' + Date.now(),
                    title: 'Test Feature',
                    description: 'A simple test feature for mode comparison',
                    tags: ['test']
                };
                
                document.getElementById('analysis-response').textContent = 
                    `Testing ${useRAG ? 'RAG' : 'Direct'} mode...\n\nNote: This might timeout - that's a known issue being worked on.`;
                
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testFeature),
                    signal: AbortSignal.timeout(20000) // 20 second timeout
                });
                
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                const data = await response.json();
                
                document.getElementById('analysis-response').textContent = 
                    `Mode: ${useRAG ? 'RAG' : 'Direct'}\nTime: ${elapsed}s\n\n` + 
                    JSON.stringify(data, null, 2);
            } catch (error) {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                document.getElementById('analysis-response').textContent = 
                    `Error after ${elapsed}s: ${error.message}\n\nThis is expected - the analysis endpoints are still being optimized.`;
            }
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                document.getElementById('health-response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('health-response').textContent = 'Error: ' + error.message;
            }
        }

        // Check status on load
        checkRAGStatus();
    </script>
</body>
</html>